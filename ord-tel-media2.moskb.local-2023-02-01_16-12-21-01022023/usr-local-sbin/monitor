#!/bin/bash

# тут будет скрипт работы с файлами записей
umask 133

DID=$1
[ `echo -n ${DID} | wc -c` -eq 7 ] && DID="812${DID}"

if [ `echo -n ${DID} | wc -c` -ne 10 ]; then
  echo "Invalid DID \"${DID}\""
  exit 1
fi

if echo "${DID}" | egrep -qv '[0-9]'; then
  echo "ERROR: non-numeric DID \"${did}\""
  exit 1
fi

CONF="/pbx/auto/ITOO/${DID}.cfg"
f="${CONF}"
CFG="/pbx/conf/ITOO/${DID}.cfg"

IN=3
OUT=3
LEVEL=3
DESCR=''

mt=`stat -c '%Y' "${CONF}" 2>/dev/null || echo 0`
echo `date "+%Y.%m.%d %H:%M"`"${SUDO_UID} ${SUDO_USER}: OPEN ${f}" >> /var/log/itoo.log

if [ "$2" != "!" ] && [ "$2" != "!!" ]; then
  nano -kiw -Y "/usr/share/nano/conf.nanorc" -o `dirname ${f}` "${CONF}"
  mt1=`stat -c '%Y' "${CONF}" 2>/dev/null || echo 0`

  if [ "$mt1" -eq "$mt" ]; then
    echo 'Config unchanged'
    exit 0
  fi
fi


echo "; AUTOGENERATED FROM \"$0 $*\"" > "${CFG}"

if [ -f "${CONF}" ]; then
  while read line || [[ -n "$line" ]]
  do
    if (echo "${line}" | egrep -iq '^\s*(IN|OUT|LEVEL|DISTINCT)\s*=\s*[0-9]+'); then
      var=`echo "${line}" | egrep -io '^\s*(IN|OUT|LEVEL|DISTINCT)' | sed 's/ //g ; s/.*/\U&/'`
      val=`echo "${line}" | cut -d '=' -f 2 | sed 's/ //g'`
      eval ${var}=${val}
      echo "${var}=${val}"
    else
      [ "${DESCR}" == "" ] && DESCR=`echo "${line}" | sed -r 's/^\s+// ; s/\s+$//'`
      echo "${line}" | egrep -qv '^\s*$' && echo "; ${line}" >> "${CFG}"
    fi
  done < "${CONF}"
else
  echo "Description file absent: \"${CONF}\""
  exit 2
fi

[ "${DISTINCT}" ] && DISTINCT="o ; Distinct limit by task"


cat <<EOF >> ${CFG}

[DEFAULT]
 Exten.Type = 'SIP/ITOO/'
 Exten.FeatureTransfer = 0
 Exten.ServiceList = 1   ; Toll-free short numbers like 060.
 Exten.Timeout = 86400   ; By default, wait for answer up to 1 day
 Func.P1 = '' ; Avoid confusion
 Func.P2 = '' ;
 Func.P3 = '' ;
 Func.P4 = '' ; Auto-clean unused arguments

[queues ${DID:3}]
[queue_members]
 interface = 'LOCAL/!ITOO+!+7${DID}@iax/n'

[Func ${DID}] ; INCOMING \$\$
 Macro = queue ; (name,play,noanswer,extra)
 P1 = ${DID:3}
 P4 = r

[Exten !+7${DID}] ; ${DESCR} >> ITOO
 CallLevel = ${LEVEL}
 RouteGroup =~ \$\$ 's/^...//' ; Cut leading "!+7"
 CallLimit = ${IN}

[Route ${DID}] ; ${DESCR} \$\$
 TAG = ; ITOO
 (SourceLow,SourceHigh) = "+7\$\$"
 Channel = 0
 Order = 9
 SetCID = \$\$
 Insecure = 1
 NoMore = 1
 CallGroup = \$\$${DISTINCT}
 CallLimit = ${OUT}
EOF

x2="${2:-!}"
echo "card ${CFG}"
/usr/local/sbin/card ${CFG} $x2 $3
res=$?

if [ ${res} -eq 0 ]; then
  echo "${conf} OK"
  rm -f "${conf}.err"
  echo `date "+%Y.%m.%d %H:%M"`"${SUDO_UID} ${SUDO_USER}: OK $3 ${f}" >> /var/log/itoo.log
  if [ "$3" == "delete" ]; then
    mv -f ${CFG} "/pbx/@TRASH@/ITOO/"
    mv -f ${CONF} "/pbx/@TRASH@/auto/ITOO/"
  fi
else
  cat "${conf}.err"
  echo `date "+%Y.%m.%d %H:%M"`"${SUDO_UID} ${SUDO_USER}: ERROR [${res}] in config ${f}" >> /var/log/itoo.log
  exit
fi
